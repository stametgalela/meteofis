<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MetaryX</title>
	
 <!-- Favicon dan ikon -->
 <link rel="icon" href="/meteofis/favicon.ico">
 <link rel="icon" href="data:,"> <!-- cegah default fallback -->
 <link rel="apple-touch-icon" sizes="180x180" href="/meteofis/apple-touch-icon.png">
 <link rel="icon" type="image/png" sizes="32x32" href="/meteofis/favicon-32x32.png">
 <link rel="icon" type="image/png" sizes="16x16" href="/meteofis/favicon-16x16.png">
 <link rel="manifest" href="/meteofis/manifest.json">
	
  <!-- âœ… Tambahan untuk iOS Splash Screen & Fullscreen -->
  <link rel="apple-touch-startup-image" href="/meteofis/android-chrome-512x512.png">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Warna tema -->
  <meta name="theme-color" content="#0d47a1">
   <!-- Web App Meta -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="MetaryX">
  <meta name="application-name" content="MetaryX">
  <meta name="theme-color" content="#0d47a1">
	
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f0f2f5;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 20px;
      box-shadow: 0 0 10px #ccc;
      border-radius: 8px;
      margin-top: 20px;
    }
    h1, h2 {
      text-align: center;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input {
      width: 100%;
      padding: 8px;
      font-size: 1em;
      box-sizing: border-box;
    }
    button {
      padding: 10px 15px;
      margin: 5px 5px 10px 0;
      font-size: 1em;
      cursor: pointer;
    }
    #output {
      margin-top: 20px;
      background: #eef;
      padding: 15px;
      border-radius: 6px;
    }
    #qffTable {
      margin-top: 10px;
      border-collapse: collapse;
      width: 100%;
    }
    #qffTable th, #qffTable td {
      border: 1px solid #999;
      padding: 8px;
      text-align: center;
    }
    #searchInput {
      margin: 10px 0;
      width: 100%;
      padding: 8px;
      font-size: 1em;
      box-sizing: border-box;
    }
	.collapsible {
  background-color: #e3f2fd;
  color: #0d47a1;
  cursor: pointer;
  padding: 10px;
  width: 100%;
  border: none;
  text-align: left;
  outline: none;
  font-size: 1.1em;
  margin-top: 10px;
  border-radius: 6px;
}

.active, .collapsible:hover {
  background-color: #bbdefb;
}

.collapsible:after {
  content: 'â–¼';
  float: right;
  margin-left: 5px;
}

.active:after {
  content: 'â–²';
}

.collapsible-content {
  padding: 0 10px;
  display: none;
  overflow: hidden;
  background-color: #f9f9f9;
  border-left: 4px solid #0d47a1;
  margin-bottom: 10px;
  border-radius: 6px;
}
button.active-tab {
  background: #0d47a1;
  color: white;
  border-radius: 6px;
}
.active-tab {
  background-color: #0d47a1;
  color: white;
  border-radius: 6px;
}
    .riwayat {
      background: #f9f9f9;
      border: 1px solid #ddd;
      padding: 10px;
      margin-top: 20px;
      border-radius: 6px;
    }

	#metarOutputWrapper button:hover {
  background-color: #ddd;
}

  </style>
	<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/meteofis/service-worker.js')
      .then(reg => {
        console.log('âœ… Service Worker registered');

        // âœ… Dengarkan pesan dari SW
        navigator.serviceWorker.addEventListener('message', event => {
          if (event.data?.type === 'NEW_VERSION_AVAILABLE') {
            const reloadBanner = document.createElement('div');
            reloadBanner.innerHTML = `
              <div style="
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #0d47a1;
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                font-weight: bold;
                box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                z-index: 9999;
                cursor: pointer;">
                ğŸ”„ Versi baru tersedia. Klik untuk muat ulang.
              </div>`;
            reloadBanner.onclick = () => location.reload();
            document.body.appendChild(reloadBanner);
          }
        });
      })
      .catch(err => console.error('âŒ SW registration failed', err));
  }
  function pad2(n) {
  return n < 10 ? '0' + n : n;
}

function getUTCMetarTime() {
  const jamInput = parseInt(document.getElementById("jam").value);
  const menitInput = parseInt(document.getElementById("menit").value);

  let utcTime;
  const now = new Date();

  // Jika input valid, gunakan input
  if (!isNaN(jamInput) && !isNaN(menitInput) &&
      jamInput >= 0 && jamInput <= 23 &&
      menitInput >= 0 && menitInput <= 59) {
    utcTime = new Date(Date.UTC(
      now.getUTCFullYear(),
      now.getUTCMonth(),
      now.getUTCDate(),
      jamInput,
      menitInput
    ));
  } else {
    // Jika tidak valid, pakai waktu sekarang
    utcTime = new Date();
  }

  // Bulatkan menit ke bawah/atas sesuai ketentuan METAR
  const minute = utcTime.getUTCMinutes();
  if (minute >= 45) {
    utcTime.setUTCMinutes(0);
    utcTime.setUTCHours(utcTime.getUTCHours() + 1);
  } else {
    utcTime.setUTCMinutes(0);
  }

  const dd = utcTime.getUTCDate();
  const hh = utcTime.getUTCHours();
  const mm = utcTime.getUTCMinutes();

  return `${pad2(dd)}${pad2(hh)}${pad2(mm)}Z`;
}

function formatVisibility(meter) {
  let result;
  if (meter >= 10000) {
    result = 9999;
  } else if (meter > 5000) {
    result = Math.floor(meter / 1000) * 1000;
  } else if (meter > 800) {
    result = Math.floor(meter / 100) * 100;
  } else {
    result = Math.floor(meter / 50) * 50;
  }
  return result.toString().padStart(4, '0');
}

function formatMetarTemp(value) {
  let rounded;

  if (value >= 0) {
    // Positif: pembulatan .5 ke atas (ceil jika tepat 0.5)
    rounded = (value % 1 === 0.5) ? Math.ceil(value) : Math.round(value);
  } else {
    // Negatif: pembulatan ke atas = mendekati nol
    const floor = Math.floor(value);
    rounded = (value - floor === -0.5) ? floor + 1 : Math.ceil(value);
  }

  // Format sesuai METAR
  if (rounded < 0) {
    return 'M' + String(Math.abs(rounded)).padStart(2, '0');
  } else {
    return String(rounded).padStart(2, '0');
  }
}

function generateMETAR() {
  const qualifier = document.getElementById("wxQualifier").value;
  const descriptor = document.getElementById("wxDescriptor").value;
  const phenomena = document.getElementById("wxPhenomena").value;
  const cloudsInput = document.getElementById("clouds").value.trim().toUpperCase();

  let sigWx = `${qualifier}${descriptor}${phenomena}`.trim();
  if (!qualifier && !descriptor && !phenomena) sigWx = "";
  // Ambil cuaca yang lalu
const past1 = document.getElementById("wxPast1").value;
let pastWeather = "";
if (past1 && past1 !== "-") {
  pastWeather = "RE" + past1;
}

  const clouds = `${sigWx} ${cloudsInput}`.trim();
  const visibilityRaw = document.getElementById("visibility").value.trim();
  const visValue = parseInt(visibilityRaw);
  const visStr = formatVisibility(visValue);
  const remarks = document.getElementById("remarks").value.trim();
  const dry = parseFloat(document.getElementById("dry").value);
  const tDew = document.getElementById("output").innerText.match(/Titik Embun: ([\d\.\-]+)/);
  const dew = tDew ? parseFloat(tDew[1]) : "";
  const windDir = parseInt(document.getElementById("windDir").value);
  const windSpeed = Math.round(parseFloat(document.getElementById("windSpeed").value));
  const jamInput = parseInt(document.getElementById("jam").value);
const menitInput = parseInt(document.getElementById("menit").value);

  // Validasi arah angin
if (isNaN(windDir) || windDir < 0 || windDir > 360) {
  alert("âš ï¸ Arah angin harus di antara 0Â° sampai 360Â°.");
  return;
}

// Validasi kecepatan angin
if (isNaN(windSpeed) || windSpeed < 0) {
  alert("âš ï¸ Kecepatan angin tidak boleh negatif atau kosong.");
  return;
}

// Validasi suhu
if (isNaN(dry)) {
  alert("âš ï¸ Suhu bola kering tidak valid.");
  return;
}

// Validasi titik embun sudah dihitung
if (!document.getElementById("output").innerText.includes("Titik Embun")) {
  alert("âš ï¸ Silakan klik tombol 'Hitung' terlebih dahulu untuk mendapatkan titik embun.");
  return;
}
const validClouds = /^((FEW|SCT|BKN|OVC|VV)[0-9]{3}(CB|TCU)?|NSC|SKC)(\s+(FEW|SCT|BKN|OVC|VV)[0-9]{3}(CB|TCU)?)*$/;
if (!validClouds.test(cloudsInput)) {
  alert("âš ï¸ Format awan tidak sesuai (contoh: FEW010 SCT020)");
  return;
}
// Validasi jarak pandang
if (!visibilityRaw || isNaN(visValue) || visValue < 0) {
  alert("âš ï¸ Jarak pandang harus berupa angka positif (dalam meter).");
  return;
}
  if (typeof window.qffTerakhir !== 'number') {
  alert("âš ï¸ Silakan klik tombol 'Hitung' terlebih dahulu untuk mendapatkan nilai QFF.");
  return;
}

// Pembulatan kustom QFF
const pembulatanQFF = (qff) => {
  const integer = Math.floor(qff);
  const desimal = qff - integer;
  return desimal >= 0.9 ? integer + 1 : integer;
};
const qnhStr = `Q${pembulatanQFF(window.qffTerakhir).toString().padStart(4, '0')}`;

  if (!clouds.trim() || isNaN(visValue) || isNaN(dry) || isNaN(dew) || isNaN(windDir) || isNaN(windSpeed)) {
  alert("Mohon isi semua data dan lakukan perhitungan terlebih dahulu.");
  return;
  }

  const time = getUTCMetarTime();
  document.getElementById("metarTime").innerText = time;

  const tempStr = `${formatMetarTemp(dry)}/${formatMetarTemp(dew)}`;
  const windStr = windSpeed >= 100
  ? `${windDir.toString().padStart(3, '0')}P99KT`
  : `${windDir.toString().padStart(3, '0')}${pad2(windSpeed)}KT`;
  const metar = `METAR WAEG ${time} ${windStr} ${visStr} ${clouds} ${tempStr} ${qnhStr}${pastWeather ? ' ' + pastWeather : ''}${remarks ? ' ' + remarks : ''}=`;

  const saidCode = `SAID40 WAEG ${time.replace("Z", "")}`;
  document.getElementById("metarOutput").innerText = `${saidCode}\n${metar}`;
  window.latestMETAR = metar;
  // ğŸ‘‡ Tampilkan tombol simpan bawah
document.getElementById("simpanMetarBawah").style.display = "block";
document.getElementById("metarOutputWrapper").scrollIntoView({ behavior: "smooth" });
}

function salinMetar() {
  const teks = document.getElementById("metarOutput").innerText;
  if (!teks) {
    alert("âš ï¸ Belum ada sandi METAR untuk disalin.");
    return;
  }

  navigator.clipboard.writeText(teks)
    .then(() => {
      const notif = document.createElement('div');
      notif.innerText = "âœ… Sandi METAR disalin!";
      Object.assign(notif.style, {
        position: 'fixed',
        bottom: '20px',
        left: '50%',
        transform: 'translateX(-50%)',
        background: '#0d47a1',
        color: 'white',
        padding: '10px 20px',
        borderRadius: '6px',
        fontWeight: 'bold',
        zIndex: 1000
      });
      document.body.appendChild(notif);
      setTimeout(() => notif.remove(), 2000);
    })
    .catch(() => alert("âŒ Gagal menyalin ke clipboard."));
}

</script>
</head>
<body>
  <div class="container">
   <h1 style="display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 2rem;">
  <img src="/meteofis/android-chrome-512x512.png" alt="Logo" style="height: 36px;">
  <span>MetaryX</span>
</h1>
    <form id="form">
      <div class="form-group">
        <label for="dry">ğŸŒ¡ï¸ Suhu Bola Kering (Â°C):</label>
        <input type="number" id="dry" step="0.1" required />
      </div>
      <div class="form-group">
        <label for="wet">ğŸŒ¡ï¸ Suhu Bola Basah (Â°C):</label>
        <input type="number" id="wet" step="0.1" required />
      </div>
      <div class="form-group">
        <label for="press">ğŸ§­ Tekanan Udara (mb):</label>
        <input type="number" id="press" step="0.1" required />
      </div>
      <div class="form-group">
        <label for="windDir">ğŸŒ¬ï¸ Arah Angin (Â°):</label>
        <input type="number" id="windDir" step="1" required />
      </div>
      <div class="form-group">
        <label for="windSpeed">ğŸ’¨ Kecepatan Angin (knot):</label>
        <input type="number" id="windSpeed" step="0.1" required />
      </div>
      <button type="button" onclick="calculate()">ğŸ” Hitung</button>
      <button type="button" onclick="clearForm()">ğŸ§¹ Clear</button>
      <button type="button" onclick="toggleTable()">ğŸ“‹ Tabel QFF</button>
      <button type="button" onclick="simpan()">ğŸ’¾ Simpan</button>
	  <button type="button" onclick="kirimWhatsApp()">ğŸ“² Kirim WhatsApp</button>
	  <button type="button" onclick="toggleMetarSection()">ğŸ“„ METAR</button>
	  <button type="button" onclick="toggleSpeciSection()">ğŸ“‘ SPECi</button>
	  <button type="button" onclick="toggleRiwayat()">ğŸ“‚ Tampilkan Riwayat</button>
    </form>

    <div id="output"></div>
	<div id="metarSection" style="margin-top: 20px; display: none;">
	<!-- Tombol scroll untuk METAR -->
<button id="scrollTopMetarFloating" onclick="scrollToTop('metar')" 
   style="display: none; position: fixed; bottom: 80px; right: 20px; 
         background: none; border: none; 
         font-size: 2em; cursor: pointer; 
         z-index: 999;">
  â¬†ï¸
</button>
<button id="scrollTopMetarStatic" onclick="scrollToTop('metar')" 
  style="margin-bottom: 10px; display: none;">
  â¬†ï¸ Kembali ke Atas
</button>
  <h2>ğŸ›°ï¸ METAR</h2>
  <p><strong>Waktu (UTC):</strong> <span id="metarTime"></span></p>
  <button type="button" class="collapsible">ğŸŒ§ï¸ Cuaca</button>
<div class="collapsible-content">
  <div class="form-group">
    <label>ğŸŒ§ï¸ Cuaca Saat Pengamatan :</label>
    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
      <select id="wxQualifier" class="metar-select" style="flex: 1;">
        <option value="">None</option>
        <option value="-">- Light</option>
        <option value="">Moderate</option>
        <option value="+">+ Heavy</option>
        <option value="VC">VC (in vicinity)</option>
      </select>
      <select id="wxDescriptor" class="metar-select" style="flex: 1;">
        <option value="">None</option>
        <option value="MI">MI Shallow</option>
        <option value="PR">PR Partial</option>
        <option value="BC">BC Patches</option>
        <option value="DR">DR Low drifting</option>
        <option value="BL">BL Blowing</option>
        <option value="SH">SH Shower</option>
        <option value="TS">TS Thunderstorm</option>
        <option value="FZ">FZ Freezing</option>
      </select>
      <select id="wxPhenomena" class="metar-select" style="flex: 1;">
        <option value="">None</option>
        <option value="RA">RA Rain</option>
        <option value="DZ">DZ Drizzle</option>
        <option value="SN">SN Snow</option>
        <option value="FG">FG Fog</option>
        <option value="BR">BR Mist</option>
        <option value="HZ">HZ Haze</option>
        <option value="SQ">SQ Squalls</option>
        <option value="FC">FC Funnel Cloud</option>
        <option value="SS">SS Sandstorm</option>
        <option value="DS">DS Duststorm</option>
        <option value="DU">DU Widespread Dust</option>
        <option value="VA">VA Volcanic Ash</option>
        <option value="UP">UP Unknown Precipitation</option>
      </select>
    </div>
  </div>
  <div class="form-group">
    <label>ğŸŒ©ï¸ Cuaca Yang Lalu :</label>
    <select id="wxPast1" style="width: 100%; font-size: 1em; padding: 6px;">
      <option value="">-</option>
      <option value="RA">RA Rain</option>
      <option value="DZ">DZ Drizzle</option>
      <option value="TS">TS Thunderstorm</option>
      <option value="TSRA">TSRA Thunderstorm With Rain</option>
      <option value="SN">SN Snow</option>
      <option value="FG">FG Fog</option>
      <option value="BR">BR Mist</option>
      <option value="HZ">HZ Haze</option>
      <option value="SQ">SQ Squalls</option>
      <option value="FC">FC Funnel Cloud (tornado/waterspout)</option>
      <option value="SS">SS Sandstorm</option>
      <option value="DS">DS Duststorm</option>
      <option value="DU">DU Widespread Dust</option>
      <option value="VA">VA Volcanic Ash</option>
      <option value="GR">GR Hail</option>
      <option value="PL">PL Ice pellets</option>
      <option value="GS">GS Small hail/snow pellets</option>
      <option value="SHRA">SHRA Rain Showers</option>
      <option value="BLSN">BLSN Blowing Snow</option>
      <option value="FZDZ">FZDZ Freezing drizzle</option>
      <option value="FZFG">FZFG Freezing fog</option>
      <option value="FZRA">FZRA Freezing rain</option>
    </select>
  </div>
</div>
	<div class="form-group">
    <label for="clouds">â˜ï¸ Awan :</label>
	<input type="text" id="clouds" placeholder="Contoh: FEW010 SCT018 BKN070">
  </div>
  <div class="form-group">
    <label for="visibility">ğŸ‘ï¸ Jarak Pandang (meter):</label>
    <input type="number" id="visibility" placeholder="contoh: 8000">
  </div>
  <button type="button" class="collapsible">ğŸ• Waktu UTC Manual (LEWATI LANGSUNG KLIK BUAT SANDI)</button>
<div class="collapsible-content">
  <div class="form-group">
    <label for="jam">ğŸ• Jam UTC:</label>
    <input type="number" id="jam" placeholder="Lewati jika otomatis" min="0" max="23">
  </div>
  <div class="form-group">
    <label for="menit">ğŸ• Menit UTC:</label>
    <input type="number" id="menit" placeholder="Lewati jika otomatis" min="0" max="59">
  </div>
</div>
  <div class="form-group">
    <label for="remarks">ğŸ“ Remark (opsional):</label>
    <input type="text" id="remarks" placeholder="Contoh: QNH1013, No significant change, dll">
  </div>
  <button type="button" onclick="generateMETAR()">ğŸ§¾ Buat Sandi METAR</button>
  <div id="metarOutputWrapper" style="position: relative; margin-top: 10px;">
  <button onclick="salinMetar()" 
    style="position: absolute; top: 6px; right: 6px; background: #eee; border: 1px solid #ccc; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; cursor: pointer;">
    ğŸ“‹
  </button>
  <div id="metarOutput" style="background: #fff3cd; padding: 10px; border-radius: 6px; white-space: pre-wrap;"></div>
  <!-- Tombol Simpan Baru (sembunyi dulu) -->
<div id="simpanMetarBawah" style="margin-top: 10px; text-align: right; display: none;">
  <button type="button" onclick="simpan()">ğŸ’¾ Simpan</button>
</div>
</div>
</div>

<div id="speciSection" style="margin-top: 20px; display: none;">
  <button id="scrollTopSpeciFloating" onclick="scrollToTop('speci')" 
    style="display: none; position: fixed; bottom: 140px; right: 20px; 
          background: none; border: none; 
          font-size: 2em; cursor: pointer; 
          z-index: 999;">
    â¬†ï¸
  </button>
  <button id="scrollTopSpeciStatic" onclick="scrollToTop('speci')" 
    style="margin-bottom: 10px; display: none;">
    â¬†ï¸ Kembali ke Atas
  </button>
  <h2>ğŸ“‘ SPECi</h2>
  <div class="form-group">
    <label>ğŸŒ§ï¸ Cuaca Saat Pengamatan:</label>
    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
      <select id="speciQualifier" style="flex: 1;">
        <option value="">None</option>
        <option value="-">- Light</option>
        <option value="">Moderate</option>
        <option value="+">+ Heavy</option>
        <option value="VC">VC</option>
      </select>
      <select id="speciDescriptor" style="flex: 1;">
        <option value="">None</option>
        <option value="TS">TS</option>
        <option value="SH">SH</option>
        <option value="FZ">FZ</option>
        <option value="BL">BL</option>
      </select>
      <select id="speciPhenomena" style="flex: 1;">
        <option value="">None</option>
        <option value="RA">RA</option>
        <option value="SN">SN</option>
        <option value="FG">FG</option>
        <option value="BR">BR</option>
      </select>
    </div>
	</div>
	<div class="form-group">
	<label>â›ˆï¸ Cuaca Yang Lalu :</label>
	<select id="speciPastWx" style="width: 100%; font-size: 1em; padding: 6px;">
    <option value="">-</option>
    <option value="RA">RA Rain</option>
    <option value="DZ">DZ Drizzle</option>
    <option value="TS">TS Thunderstorm</option>
    <option value="TSRA">TSRA Thunderstorm With Rain</option>
    <option value="SN">SN Snow</option>
    <option value="FG">FG Fog</option>
    <option value="BR">BR Mist</option>
    <option value="HZ">HZ Haze</option>
    <option value="SQ">SQ Squalls</option>
    <option value="FC">FC Funnel Cloud</option>
    <option value="SS">SS Sandstorm</option>
    <option value="DS">DS Duststorm</option>
    <option value="DU">DU Widespread Dust</option>
    <option value="VA">VA Volcanic Ash</option>
    <option value="GR">GR Hail</option>
    <option value="PL">PL Ice pellets</option>
    <option value="GS">GS Small hail/snow pellets</option>
    <option value="SHRA">SHRA Rain Showers</option>
    <option value="BLSN">BLSN Blowing Snow</option>
    <option value="FZDZ">FZDZ Freezing drizzle</option>
    <option value="FZFG">FZFG Freezing fog</option>
    <option value="FZRA">FZRA Freezing rain</option>
	</select>
	</div>
  <div class="form-group">
    <label for="speciClouds">â˜ï¸ Awan :</label>
    <input type="text" id="speciClouds" placeholder="Contoh: FEW010 BKN020 CB">
  </div>
  <div class="form-group">
    <label for="speciVis">ğŸ‘ï¸ Jarak Pandang (meter):</label>
    <input type="number" id="speciVis" placeholder="contoh: 6000">
  </div>
  <div class="form-group">
    <label for="speciJam">ğŸ• Jam UTC:</label>
    <input type="number" id="speciJam" placeholder="0-23" min="0" max="23">
  </div>
  <div class="form-group">
    <label for="speciMenit">ğŸ• Menit UTC:</label>
    <input type="number" id="speciMenit" placeholder="0-59" min="0" max="59">
  </div>
  <button type="button" onclick="generateSPECi()">ğŸ“‘ Buat SPECi</button>
  <div id="speciOutputWrapper" style="position: relative; margin-top: 10px;">
    <button onclick="salinSpeci()" 
      style="position: absolute; top: 6px; right: 6px; background: #eee; border: 1px solid #ccc; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; cursor: pointer;">
      ğŸ“‹
    </button>
    <div id="speciOutput" style="background: #e1f5fe; padding: 10px; border-radius: 6px; white-space: pre-wrap;"></div>
	<div id="simpanSpeciBawah" style="margin-top: 10px; text-align: right;">
  <button type="button" onclick="simpanSpeci()">ğŸ’¾ Simpan SPECi</button>
	</div>
  </div>
</div>

    <!-- Tombol scroll untuk QFF -->
<div id="qffContainer" style="display: none; margin-top: 20px;">
  <!-- Tombol scroll untuk QFF -->
  <button id="scrollTopQFFFloating" onclick="scrollToTop('qff')" 
    style="display: none; position: fixed; bottom: 20px; right: 20px; 
          background: none; border: none; 
          font-size: 2em; cursor: pointer; 
          z-index: 999;">
    â¬†ï¸
  </button>
  <button id="scrollTopQFFStatic" onclick="scrollToTop('qff')" 
    style="margin-bottom: 10px; display: none;">
    â¬†ï¸ Kembali ke Atas
  </button>

  <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="ğŸ” Cari QFF...">
  <table id="qffTable">
    <thead>
      <tr><th>Tekanan (mb)</th><th>QFF (mb)</th></tr>
    </thead>
    <tbody id="qffBody"></tbody>
  </table>
</div>

    <div class="riwayat" id="riwayatWrapper" style="display: none;">
  <!-- Tombol Tab Tetap Terlihat -->
  <div id="tabContainer" style="display: flex; gap: 10px; margin-bottom: 10px;">
    <button onclick="showTab('metar')" id="tabMetar" style="flex: 1;">ğŸ§¾ Riwayat METAR</button>
    <button onclick="showTab('speci')" id="tabSpeci" style="flex: 1;">ğŸ“‘ Riwayat SPECi</button>
  </div>

  <!-- Konten Tab -->
  <div id="riwayatMetarList" style="display: none;"></div>
  <div id="riwayatSpeciList" style="display: none;"></div>

  <button onclick="hapusRiwayat()" style="margin-top: 10px;">ğŸ—‘ï¸ Hapus Semua</button>
</div>
 
  <script>
    function calculate() {
  const dry = parseFloat(document.getElementById("dry").value);
  const wet = parseFloat(document.getElementById("wet").value);
  const press = parseFloat(document.getElementById("press").value);
  const windDir = parseInt(document.getElementById("windDir").value);
  const windSpeed = parseFloat(document.getElementById("windSpeed").value);
  const elev = 37;

  if (isNaN(dry) || isNaN(wet) || isNaN(press) || isNaN(windDir) || isNaN(windSpeed)) {
    alert("Mohon isi semua kolom dengan benar.");
    return;
  }

  const eWet = 6.112 * Math.exp((17.62 * wet) / (243.12 + wet));
  const eDry = 6.112 * Math.exp((17.62 * dry) / (243.12 + dry));
  const e = eWet - press * (dry - wet) * 0.00066 * (1 + 0.00115 * wet);
  const rh = Math.round((e / eDry) * 100);
  const tDew = (243.12 * Math.log(e / 6.112)) / (17.62 - Math.log(e / 6.112));

  const T = dry + 273.15;
  const QFF = press + (0.12 * elev) + (0.0005 * T);
  const QFE = press + 0.5;

  const windDirText = getWindDirection(windDir);
  const speedKMH = (windSpeed * 1.852).toFixed(1);

  const now = new Date();
  const local = now.toLocaleString("sv-SE");
  const utc = new Date(now.getTime() - (9 * 60 * 60 * 1000)).toLocaleString("sv-SE") + " UTC";

  const output = `
    <h2>ğŸ•“ Waktu Pengamatan:</h2>
    <p>Lokal: ${local}<br/>UTC: ${utc}</p>
    <p>ğŸŒ¡ï¸ Bola Kering: ${dry.toFixed(1)} Â°C<br/>
    ğŸŒ¡ï¸ Bola Basah: ${wet.toFixed(1)} Â°C<br/>
    ğŸŒ¡ï¸ Titik Embun: ${tDew.toFixed(1)} Â°C<br/>
    ğŸ’§ Kelembapan Relatif: ${rh} %</p>
    <p>ğŸ§­ Tekanan Udara: ${press.toFixed(1)} mb<br/>
    ğŸ“ˆ QFF: ${QFF.toFixed(1)} mb / ${(QFF * 0.02953).toFixed(2)} inchHg<br/>
    ğŸ“‰ QFE: ${QFE.toFixed(1)} mb / ${(QFE * 0.02953).toFixed(2)} inchHg</p>
    <p>ğŸŒ¬ï¸ Arah Angin: ${windDir}Â° (${windDirText})<br/>
    ğŸ’¨ Kecepatan: ${Math.round(windSpeed)} knot (${speedKMH} km/jam)</p>
  `;
  document.getElementById("output").innerHTML = output;
  window.qffTerakhir = QFF;  // âœ… Simpan QFF asli ke variabel global
  document.getElementById("output").scrollIntoView({ behavior: "smooth" });

  // generateMETAR();  // âŒ Jangan panggil otomatis saat hitung
  document.getElementById("output").scrollIntoView({ behavior: "smooth" });  // âœ… Auto-scroll ke bawah
}

    function simpan() {
  const outputText = document.getElementById("output").innerHTML;
  const metarText = document.getElementById("metarOutput").innerText;
  const utcWaktu = document.getElementById("metarTime").innerText || "";

  if (!outputText && !metarText) {
    alert("âš ï¸ Tidak ada data pengamatan atau METAR untuk disimpan.");
    return;
  }

  const dataGabungan = `
    <div style="border:1px solid #ddd; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
      <h4 style="margin-bottom: 8px;">ğŸ“¡ <strong>Pengamatan:</strong></h4>
      ${outputText}
      <h4 style="margin-top: 15px; margin-bottom: 6px;">ğŸ§¾ <strong>METAR:</strong></h4>
      <pre style="
        background: #f7f7f7;
        padding: 10px;
        border: 1px dashed #aaa;
        border-radius: 6px;
        font-family: 'Courier New', Courier, monospace;
        font-size: 0.95em;
        white-space: pre-wrap;
        color: #333;
      ">${metarText}</pre>
    </div>
  `;

  let riwayat = JSON.parse(localStorage.getItem("riwayat") || "[]");

  // Cari entri yang punya waktu UTC sama
  const index = riwayat.findIndex(item => item.includes(`UTC: ${utcWaktu} UTC`));

  if (index !== -1) {
    // Update METAR saja
    riwayat[index] = riwayat[index].replace(
      /(<h4 style="margin-top: 15px; margin-bottom: 6px;">ğŸ§¾ <strong>METAR:<\/strong><\/h4>)([\s\S]*?<pre[\s\S]*?>)[\s\S]*?<\/pre>/,
      `$1$2${metarText}</pre>`
    );
  } else {
    // Tambah baru jika tidak ditemukan
    riwayat.push(dataGabungan);
  }

  localStorage.setItem("riwayat", JSON.stringify(riwayat));
  tampilkanRiwayat();
}

function simpanSpeci() {
  const outputText = document.getElementById("output").innerHTML;
  const speciText = document.getElementById("speciOutput").innerText;
  const utcMatch = speciText.match(/SPECI WAEG (\d{6})Z/);
  const utcWaktu = utcMatch ? utcMatch[1] : "";

  if (!outputText && !speciText) {
    alert("âš ï¸ Tidak ada data pengamatan atau SPECi untuk disimpan.");
    return;
  }

  const dataGabungan = `
    <div style="border:1px solid #ddd; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
      <h4 style="margin-bottom: 8px;">ğŸ“¡ <strong>Pengamatan:</strong></h4>
      ${outputText}
      <h4 style="margin-top: 15px; margin-bottom: 6px;">ğŸ“‘ <strong>SPECi:</strong></h4>
      <pre style="
        background: #e8f5e9;
        padding: 10px;
        border: 1px dashed #4caf50;
        border-radius: 6px;
        font-family: 'Courier New', Courier, monospace;
        font-size: 0.95em;
        white-space: pre-wrap;
        color: #333;
      ">${speciText}</pre>
    </div>
  `;

  let riwayat = JSON.parse(localStorage.getItem("riwayat") || "[]");

  // Cek apakah SPECi sudah pernah disimpan berdasarkan waktu UTC
  const index = riwayat.findIndex(item => item.includes(`SPECI WAEG ${utcWaktu}Z`));
  if (index !== -1) {
    riwayat[index] = dataGabungan;  // Gantikan
  } else {
    riwayat.push(dataGabungan);     // Tambah baru
  }

  localStorage.setItem("riwayat", JSON.stringify(riwayat));
  tampilkanRiwayat();
}

	function kirimWhatsApp() {
  const outputText = document.getElementById("output").innerText;
  const metarText = document.getElementById("metarOutput").innerText;

  if (!outputText && !metarText) {
    alert("Silakan hitung dan buat sandi METAR terlebih dahulu.");
    return;
  }

  const pesan = encodeURIComponent(
    `ğŸ“¡ *Pengamatan Cuaca:*\n${outputText}\n\nğŸ§¾ *Sandi METAR:*\n${metarText}`
  );

  const url = `https://wa.me/?text=${pesan}`;
  window.open(url, "_blank");
}

function showTab(tab) {
  const metarDiv = document.getElementById("riwayatMetarList");
  const speciDiv = document.getElementById("riwayatSpeciList");
  const tabMetar = document.getElementById("tabMetar");
  const tabSpeci = document.getElementById("tabSpeci");

  if (tab === "metar") {
    metarDiv.style.display = "block";
    speciDiv.style.display = "none";
    tabMetar.classList.add("active-tab");
    tabSpeci.classList.remove("active-tab");
  } else if (tab === "speci") {
    metarDiv.style.display = "none";
    speciDiv.style.display = "block";
    tabSpeci.classList.add("active-tab");
    tabMetar.classList.remove("active-tab");
  }
}

function toggleRiwayat() {
  const wrapper = document.getElementById("riwayatWrapper");
  const metarDiv = document.getElementById("riwayatMetarList");
  const speciDiv = document.getElementById("riwayatSpeciList");
  const tabMetar = document.getElementById("tabMetar");
  const tabSpeci = document.getElementById("tabSpeci");

  if (wrapper.style.display === "none") {
    wrapper.style.display = "block";
    // Tetap tidak mengaktifkan tab apa pun dulu
    wrapper.scrollIntoView({ behavior: "smooth" });
  } else {
    wrapper.style.display = "none";
    metarDiv.style.display = "none";
    speciDiv.style.display = "none";
    tabMetar.classList.remove("active-tab");
    tabSpeci.classList.remove("active-tab");
  }
}

    function tampilkanRiwayat() {
  let riwayat = JSON.parse(localStorage.getItem("riwayat") || "[]");
  const metarContainer = document.getElementById("riwayatMetarList");
  const speciContainer = document.getElementById("riwayatSpeciList");
  metarContainer.innerHTML = "";
  speciContainer.innerHTML = "";

  riwayat.forEach((item) => {
    const wrapper = document.createElement("div");
    wrapper.innerHTML = item;
    wrapper.style.marginBottom = "20px";

    if (item.includes("ğŸ§¾ <strong>METAR:")) {
      metarContainer.appendChild(wrapper);
    } else if (item.includes("ğŸ“‘ <strong>SPECi:")) {
      speciContainer.appendChild(wrapper);
    }
  });
}

    function hapusRiwayat() {
      if (confirm("Hapus semua riwayat pengamatan?")) {
        localStorage.removeItem("riwayat");
        tampilkanRiwayat();
      }
    }

    function clearForm() {
  document.getElementById("form").reset();
  document.getElementById("output").innerHTML = "";
  document.getElementById("metarOutput").innerText = "";
  document.getElementById("metarTime").innerText = "";
  window.qffTerakhir = undefined;

  // ğŸ”„ Reset semua input METAR manual
  const fieldsToClear = [
    "wxQualifier", "wxDescriptor", "wxPhenomena",
    "wxPast1", "clouds", "visibility",
    "jam", "menit", "remarks"
  ];
  fieldsToClear.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = "";
  });

  // âŒ Sembunyikan tombol simpan bawah jika ada
  const simpanBtn = document.getElementById("simpanMetarBawah");
  if (simpanBtn) simpanBtn.style.display = "none";
}

    function getWindDirection(deg) {
      const directions = ["Utara", "Timur Laut", "Timur", "Tenggara", "Selatan", "Barat Daya", "Barat", "Barat Laut"];
      const i = Math.floor((deg + 22.5) / 45) % 8;
      return directions[i];
    }

   function toggleTable() {
  const container = document.getElementById("qffContainer");
  const show = container.style.display === "none" || container.style.display === "";
  container.style.display = show ? "block" : "none";
  document.getElementById("scrollTopQFFFloating").style.display = show ? "inline-block" : "none";
  document.getElementById("scrollTopQFFStatic").style.display = show ? "inline-block" : "none";

  if (show) {
    setTimeout(() => {
      container.scrollIntoView({ behavior: "smooth", block: "start" });
    }, 100);
  }
}

   function scrollToTop(section) {
  window.scrollTo({ top: 0, behavior: "smooth" });

  setTimeout(() => {
    if (section === 'qff') {
      const qff = document.getElementById("qffContainer");
      const btnFloat = document.getElementById("scrollTopQFFFloating");
      const btnStatic = document.getElementById("scrollTopQFFStatic");
      qff.style.display = "none";
      btnFloat.style.display = "none";
      btnStatic.style.display = "none";
    } else if (section === 'metar') {
      const metarSection = document.getElementById("metarSection");
      const btnFloat = document.getElementById("scrollTopMetarFloating");
      const btnStatic = document.getElementById("scrollTopMetarStatic");
      metarSection.style.display = "none";
      btnFloat.style.display = "none";
      btnStatic.style.display = "none";
    }
	  else if (section === 'speci') {
	  const speciSection = document.getElementById("speciSection");
      const btnFloat = document.getElementById("scrollTopSpeciFloating");
	  const btnStatic = document.getElementById("scrollTopSpeciStatic");
	  speciSection.style.display = "none";
	  btnFloat.style.display = "none";
	btnStatic.style.display = "none";
	}
  }, 500);
}

    function toggleMetarSection() {
  const section = document.getElementById("metarSection");
  const isHidden = section.style.display === "none" || section.style.display === "";

  section.style.display = isHidden ? "block" : "none";

  if (isHidden) {
    section.scrollIntoView({ behavior: "smooth" });

    // âœ… Tampilkan tombol scroll ke atas juga
    document.getElementById("scrollTopMetarFloating").style.display = "inline-block";
document.getElementById("scrollTopMetarStatic").style.display = "inline-block";
  } else {
    // âŒ Jika disembunyikan, tombol scroll juga disembunyikan
document.getElementById("scrollTopMetarFloating").style.display = "none";
document.getElementById("scrollTopMetarStatic").style.display = "none";
  }
}

function toggleSpeciSection() {
  const section = document.getElementById("speciSection");
  const isHidden = section.style.display === "none" || section.style.display === "";

  section.style.display = isHidden ? "block" : "none";
  document.getElementById("scrollTopSpeciFloating").style.display = isHidden ? "inline-block" : "none";
  document.getElementById("scrollTopSpeciStatic").style.display = isHidden ? "inline-block" : "none";

  if (isHidden) section.scrollIntoView({ behavior: "smooth" });
}

function generateSPECi() {
  const qualifier = document.getElementById("speciQualifier").value;
  const descriptor = document.getElementById("speciDescriptor").value;
  const phenomena = document.getElementById("speciPhenomena").value;
  const clouds = document.getElementById("speciClouds").value.trim().toUpperCase();
  const vis = parseInt(document.getElementById("speciVis").value);
  const jam = parseInt(document.getElementById("speciJam").value);
  const menit = parseInt(document.getElementById("speciMenit").value);

  if (isNaN(vis) || vis < 0 || !clouds) {
    alert("Mohon isi awan dan visibilitas dengan benar.");
    return;
  }

  if (isNaN(jam) || isNaN(menit) || jam < 0 || jam > 23 || menit < 0 || menit > 59) {
    alert("Jam dan menit UTC tidak valid.");
    return;
  }

  // Ambil data dari hasil pengamatan
  const windDir = parseInt(document.getElementById("windDir").value);
  const windSpeed = Math.round(parseFloat(document.getElementById("windSpeed").value));
  const outputText = document.getElementById("output").innerText;
  const tDewMatch = outputText.match(/Titik Embun: ([\d\.\-]+)/);
  const tempMatch = outputText.match(/Bola Kering: ([\d\.\-]+)/);
  const qff = window.qffTerakhir;

  if (isNaN(windDir) || isNaN(windSpeed) || !tDewMatch || !tempMatch || typeof qff !== 'number') {
    alert("âš ï¸ Data pengamatan belum lengkap. Harap klik 'Hitung' terlebih dahulu.");
    return;
  }

  const dew = parseFloat(tDewMatch[1]);
  const dry = parseFloat(tempMatch[1]);

  const windStr = windSpeed >= 100
    ? `${windDir.toString().padStart(3, '0')}P99KT`
    : `${windDir.toString().padStart(3, '0')}${String(windSpeed).padStart(2, '0')}KT`;

  const tempStr = `${formatMetarTemp(dry)}/${formatMetarTemp(dew)}`;

  // Pembulatan QFF ke format METAR
  const pembulatanQFF = (qff) => {
    const integer = Math.floor(qff);
    const desimal = qff - integer;
    return desimal >= 0.9 ? integer + 1 : integer;
  };
  const qnhStr = `Q${pembulatanQFF(qff).toString().padStart(4, '0')}`;

	const now = new Date();
	const timeStr = `${pad2(now.getUTCDate())}${pad2(jam)}${pad2(menit)}Z`;
	const saidCode = `SPID40 WAEG ${timeStr.replace("Z", "")}`;
	const wx = `${qualifier}${descriptor}${phenomena}`.trim();
	const pastWxCode = document.getElementById("speciPastWx").value;
	const pastWxStr = pastWxCode ? ` RE${pastWxCode}` : "";

	const spe = `SPECI WAEG ${timeStr} ${windStr} ${formatVisibility(vis)} ${wx} ${clouds} ${tempStr} ${qnhStr}${pastWxStr}=`.replace(/\s+/g, ' ').trim();

  document.getElementById("speciOutput").innerText = `${saidCode}\n${spe}`;
  document.getElementById("speciOutputWrapper").scrollIntoView({ behavior: "smooth" });
}

function salinSpeci() {
  const teks = document.getElementById("speciOutput").innerText;
  if (!teks) {
    alert("âš ï¸ Belum ada sandi SPECi untuk disalin.");
    return;
  }

  navigator.clipboard.writeText(teks)
    .then(() => {
      const notif = document.createElement('div');
      notif.innerText = "âœ… Sandi SPECi disalin!";
      Object.assign(notif.style, {
        position: 'fixed',
        bottom: '20px',
        left: '50%',
        transform: 'translateX(-50%)',
        background: '#0d47a1',
        color: 'white',
        padding: '10px 20px',
        borderRadius: '6px',
        fontWeight: 'bold',
        zIndex: 1000
      });
      document.body.appendChild(notif);
      setTimeout(() => notif.remove(), 2000);
    })
    .catch(() => alert("âŒ Gagal menyalin ke clipboard."));
}

    function filterTable() {
      const input = document.getElementById("searchInput").value.toUpperCase();
      const tr = document.querySelectorAll("#qffTable tbody tr");
      tr.forEach(row => {
        const qffCell = row.getElementsByTagName("td")[1];
        row.style.display = qffCell.textContent.toUpperCase().indexOf(input) > -1 ? "" : "none";
      });
    }

    window.onload = function () {
      tampilkanRiwayat();
      const tbody = document.getElementById("qffBody");
      const elev = 37;
      for (let p = 995.0; p <= 1015.0; p += 0.1) {
        const T = 303.15;
        const qff = p + (0.12 * elev) + (0.0005 * T);
        const row = `<tr><td>${p.toFixed(1)}</td><td>${qff.toFixed(1)}</td></tr>`;
        tbody.insertAdjacentHTML("beforeend", row);
		showTab('metar');
      }
    };

    document.getElementById("form").addEventListener("submit", function (e) {
      e.preventDefault();
      calculate();
    });
	function showTab(tab) {
  const metarDiv = document.getElementById("riwayatMetarList");
  const speciDiv = document.getElementById("riwayatSpeciList");
  const tabMetar = document.getElementById("tabMetar");
  const tabSpeci = document.getElementById("tabSpeci");

  if (tab === "metar") {
    metarDiv.style.display = "block";
    speciDiv.style.display = "none";
    tabMetar.classList.add("active-tab");
    tabSpeci.classList.remove("active-tab");
  } else {
    metarDiv.style.display = "none";
    speciDiv.style.display = "block";
    tabSpeci.classList.add("active-tab");
    tabMetar.classList.remove("active-tab");
  }
}
  </script>
  <script>
  // Collapsible untuk bagian cuaca
  document.addEventListener("DOMContentLoaded", function () {
    const collapsibles = document.querySelectorAll(".collapsible");
    collapsibles.forEach(btn => {
      btn.addEventListener("click", function () {
        this.classList.toggle("active");
        const content = this.nextElementSibling;
        if (content.style.display === "block") {
          content.style.display = "none";
        } else {
          content.style.display = "block";
        }
      });
    });
  });
  
</script>

</body>
</html>
